## Release Engineering

### Preparation Before Publishing Settings

- Hybrid currently only supports iOS
- Install the latest version of launcher
- Install Xcode 
    - Minimum version: 9.0
    -  Later, modification and function access of the publishing project need to be completed in Xcode

### Publish the Project
- In the launcher's project palette, find the Egret project that you want to publish your iOS project, and click on the publish Settings

![](p0.png)

- Click the iOS button on the left, enter the application name and application package name on the right page, and click ok.**check to use Hybrid scheme**

![](p1.png)

### Pay Attention 

-  Double-click the xcworkspace file to open the project
- The project you created opens the sample game by default, and you need to modify the game address yourself

## Description of Engineering Template

The default project starts the game locally.

### Start the Process

- Initialize EgretWebViewLib

```
[EgretWebViewLib initialize:@"/egretGame/preload/"];
// "/egretGame/preload/"It's the cache directory, under the document directory that you're applying.
```
- Check that the game resources have been deployed to the local server

```
[EgretWebViewLib checkLoaded:zipFilePath Host:host]
// ZipFilePath is the absolute path to the game resource zip
// Host which url is mapped to the game, such as the host "https://egret.com/game/", the corresponding game url for "https://egret.com/game/index.html"
```
- Deploy the game resources to the local server

```
ZipFileLoader* loader = [EgretWebViewLib createZipFileLoader:zipFilePath Host:host Delegate:self];
[loader start];
```
- Start the Game

```
[EgretWebViewLib startLocalServer]; // Start the local server
[EgretWebViewLib startGame:gameUrl SuperView:self.view]; // Start the game
```

## There are Three Other Ways to Start

### Start the Game Directly

```objective-c
[EgretWebViewLib startGame:gameUrl SuperView:self.view];
// GameUrl is the url of the game
```

### Start the Game from the Resources Directory

0.1.11Version to add

```objective-c
[EgretWebViewLib startLocalServerFromResource];
[EgretWebViewLib startGame:indexFilePath SuperView:self.view];
// IndexFilePath is the index.html file of the game relative to Resources
```

As shown in the figure below, indexFilePath is "game/index.html". You need to make sure that the game Resources directory has been added to Copy Bundle Resources.

![](p2.png)

### Download the Game Resources to the Local, From the Local Launch the Game

- Check the version of the local game resource (depending on the file name)

```objective-c
[EgretWebViewLib checkLoaded:];
```

- Download Game Resources

```objective-c
ZipFileLoader* loader = [EgretWebViewLib createZipFileLoader: Delegate:];
[loader start];
```

- Start the Local Server and the Game

```objective-c
[EgretWebViewLib startLocalServer];
[EgretWebViewLib startGame: SuperView:];
```

## JS Communicates with OC

The logic is the same as Android Native, except that the apis for Native projects are different.

How to register to receive messages:

```objective-c
[EgretWebViewLib setExternalInterface:@"sendToNative" Callback:^(NSString* msg) {
    NSLog(@"message: %@", msg);
}];
```

Send message:

```objective-c
[EgretWebViewLib callExternalInterface:@"sendToJS" Value:@"message from OC"];
```

## Resource Management Strategy

0.1.12 Version to add

### Put Part of the Resources

Start to support local partial resources, local does not exist resources will be downloaded to the server.

You need to set the directory on the server corresponding to index.html when starting the game.End with '/', like "http://tool.egret-labs.org/Weiduan/game/".

```
+ (void)startGame:(NSString*)gameUrl Host:(NSString*)host SuperView:(UIView*)superView;
```

### The Order in Which Resources are Found

Dynamically download resources in the directory > local resources > server resources

 Dynamic download directory resources:Based on the directory generated by the host passed in when starting the game,Depending on the directory generated by the host passed in when the game is started, resources that do not exist locally are downloaded here. Can pass ` + (nsstrings *) getPreloadPathByGameUrl (gameUrl nsstrings *); `Get the absolute path to this directory and parameter is the index of the server. The HTML addresses, such as "http://tool.egret-labs.org/Weiduan/game/index.html".

Local resources: resources extracted after launching the game in zip mode, or resources directly under the Resource directory.

### Update Strategy

Dynamically downloaded resources or local resources will no longer go to the server to download, need to manually update.

Two reference update schemes:

- Download resources locally through ZipFileLoader. ZipFileLoader automatically overrides old resources and gets the current version.
- Manually download the updated resources to the dynamic download directory.

## Frequently Asked Questions in App Store Audit

### It's no Different than the Browser Experience

> Your app provides a limited user experience as it is not sufficiently different from a mobile browsing experience. As such, the experience it provides is similar to the general experience of using Safari. Including iOS features such as push notifications, Core Location, and sharing do not provide a robust enough experience to be appropriate for the App Store.

Solution: add native features to differentiate the application experience from Safari.

If you add only obscure native functionality,If you call the native SDK through ExternalInterface to log in,It may not pass manual review.

### The Resources Need to be Decompressed When the Application Starts

> Your app did not include sufficient content in the binary for the app to function at launch, and we were required to download or unpack additional resources before we could use it.

Solution:

1. Modify the startup logic, open the application after the display of other interfaces, no perception of download and decompression of game resources.

2. Directly launch the game * or * launch the game * from the Resources directory when auditing.

##  Pay Attention

### Web Store

If you start the game from a local server,The problem of "Web storage failure" may occur.For example, localStorage cannot get the data saved at the last startupï¼ŒThe reason is that the port number occupied by the local server is not fixed every time the local server is started (the fixed port number may be rejected by the audit).This part of the data cannot be Shared according to the browser cache policy.

Solution: call the native code through ExternalInterface to store the data.

## The Sample Project

[download address](http://tool.egret-labs.org/DocZip/native/demo_ios_hybrid.zip)